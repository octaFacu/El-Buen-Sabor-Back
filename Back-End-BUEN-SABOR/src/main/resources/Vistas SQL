PROCEDIMIENTO PARA QUE FUNCIONE QUERY RANKING CLIENTES

DELIMITER //

CREATE PROCEDURE obtener_informacion_ranking_cliente(
    IN fecha_inicio DATE,
    IN fecha_fin DATE,
    IN campo_orden VARCHAR(50),
    IN direccion_orden VARCHAR(4)
)
BEGIN
    SET @filtro_fechas = '';

    IF fecha_inicio IS NOT NULL AND fecha_fin IS NOT NULL THEN
        SET @filtro_fechas = CONCAT('AND DATE(p.fecha_pedido) BETWEEN "', fecha_inicio, '" AND "', fecha_fin, '"');
    END IF;

    SET @orden = '';

    IF campo_orden IS NOT NULL AND direccion_orden IS NOT NULL THEN
        SET @orden = CONCAT('ORDER BY ', campo_orden, ' ', direccion_orden);
    END IF;

    SET @sql = CONCAT('
        SELECT
            c.id_cliente AS id_cliente,
            u.nombre,
            COUNT(p.precio_total) AS cantidad_pedidos,
            IFNULL(SUM(p.precio_total), 0) AS importe_total
        FROM
            usuario u
            INNER JOIN cliente c ON c.usuario_id = u.id
            LEFT JOIN pedido p ON c.id_cliente = p.cliente_id ', @filtro_fechas, '
        GROUP BY
            u.id, u.nombre ', @orden, ';
    ');

    PREPARE stmt FROM @sql;
    EXECUTE stmt;
    DEALLOCATE PREPARE stmt;
END //

DELIMITER ;